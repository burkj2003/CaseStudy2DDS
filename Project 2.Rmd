---
title: "Project 2"
author: "Jason Burk"
date: "11/21/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}

# set up the libraries used for R
library(caret)
library(e1071)
library(class)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(GGally)
library(tibble)
library(ggthemes)

# read in the data from .CSV files
Comp = read.csv("~/03-School/DS 6306/Project 2/CaseStudy2-data.csv")
CompNoSal = read.csv("~/03-School/DS 6306/Project 2/CaseStudy2CompSet No Salary.csv")
CompNoAtt = read.csv("~/03-School/DS 6306/Project 2/CaseStudy2CompSet No Attrition.csv")
cols = dim(Comp)[1]

# Filter Attrition
CompAtt <- Comp %>% filter(Attrition == "Yes")
CompNoAtt <- Comp %>% filter(Attrition == "No")

# Add missing columns to Competition Sets
CompNoAtt <- CompNoAtt %>% add_column(Attrition="", .after = "Age")
CompNoSal <- CompNoSal %>% add_column(MonthlyIncome=0, .after = "MaritalStatus")

# Test the data to see if any N/A data, if so remove the n/a data
if (any(is.na(Comp))) {
  Comp <- na.omit(Comp)
}
if (any(is.na(CompNoSal))) {
  CompNoSal <- na.omit(CompNoSal)
}
if (any(is.na(CompNoAtt))) {
  CompNoAtt <- na.omit(CompNoAtt)
}

################################

# Plot charts

gg <- ggplot(Comp, aes(x=Age, y=MonthlyIncome)) + 
  geom_point(aes(col=Attrition)) + 
  geom_smooth(method="loess", se=F) + 
  xlim(c(18, 60)) + 
  ylim(c(1000, 20000)) + 
  labs(subtitle="Age Vs Income", 
       y="Monthly Income", 
       x="Age", 
       title="Scatterplot")

plot(gg)


gg <- ggplot(Comp, aes(x=Age, y=DistanceFromHome)) + 
  geom_point(aes(col=Attrition)) + 
  geom_smooth(method="loess", se=F) + 
  xlim(c(18, 60)) + 
  ylim(c(1, 29)) + 
  labs(subtitle="Age Vs Distance From Home", 
       y="Distance", 
       x="Age", 
       title="Scatterplot")

plot(gg)

gg <- ggplot(Comp, aes(x=Age, y=YearsAtCompany)) + 
  geom_point(aes(col=Attrition)) + 
  geom_smooth(method="loess", se=F) + 
  xlim(c(18, 60)) + 
  ylim(c(0, 33)) + 
  labs(subtitle="Age Vs Years at the Company", 
       y="Years", 
       x="Age", 
       title="Scatterplot")

plot(gg)

gg <- ggplot(Comp, aes(x=YearsAtCompany, y=MonthlyIncome)) + 
  geom_point(aes(col=Attrition)) + 
  geom_smooth(method="loess", se=F) + 
  xlim(c(0, 33)) + 
  ylim(c(1000, 20000)) + 
  labs(subtitle="Years at the Company vs Monthly Income", 
       y="Monthly Income", 
       x="Years at the Company", 
       title="Scatterplot")

plot(gg)

### no
g <- ggplot(Comp, aes(YearsAtCompany))
g + geom_density(aes(fill=factor(Attrition)), alpha=0.8) + 
    labs(title="Density plot", 
         subtitle="City Mileage Grouped by Number of cylinders",
         caption="Source: mpg",
         x="Years at the Company",
         fill="Attrition")


### no
brks <- seq(-15000000, 15000000, 5000000)
lbls = paste0(as.character(c(seq(15, 0, -5), seq(5, 15, 5))), "m")

# Plot  
ggplot(Comp, aes(x = Education, y = YearsAtCompany, fill = Attrition)) +   # Fill column
                              geom_bar(stat = "identity", width = .8) +   # draw the bars
                              scale_y_continuous(breaks = brks,   # Breaks
                                                 labels = lbls) + # Labels
                              coord_flip() +  # Flip axes
                              labs(title="Attrition Based on Education") +
                              theme_tufte() +  # Tufte theme from ggfortify
                              theme(plot.title = element_text(hjust = .5), 
                                    axis.ticks = element_blank()) +   # Centre plot title
                              scale_fill_brewer(palette = "Dark2") # Color palette


########


ggplot(data=Comp, aes(x=Education, y=YearsAtCompany, fill=Attrition), inherit.aes = F) +
  geom_bar(stat="identity")+
  geom_text(aes(y=label_ypos, label=len), vjust=1.6, 
            color="white", size=3.5)+
  scale_fill_brewer(palette="Paired")+
  theme_minimal()


hist(CompAtt$MonthlyIncome, col = "red", breaks = 50, 
    main = "Monthly Income (Attrition)", xlab = "Monthly Income", ylab = "Occurances") 
hist(CompNoAtt$MonthlyIncome, col = "green", breaks = 50,
    main = "Monthly Income (No Attrition)", xlab = "Monthly Income", ylab = "Occurances") 

hist(CompAtt$DistanceFromHome, col = "red", breaks = 29,
     main = "Distance from Home (Attrition)", xlab = "Distance from Home", ylab = "Occurances") 
hist(CompNoAtt$DistanceFromHome, col = "green", breaks = 29,
     main = "Distance from Home (No Attrition)", xlab = "Distance from Home", ylab = "Occurances") 

hist(CompAtt$JobLevel, col = "red", breaks = 5,
     main = "Job Level (Attrition)", xlab = "Job Level", ylab = "Occurances") 
hist(CompNoAtt$JobLevel, col = "green", breaks = 5,
     main = "Job Level (No Attrition)", xlab = "Job Level", ylab = "Occurances") 

hist(CompAtt$JobSatisfaction, col = "red", breaks = 4,
     main = "Job Satisfaction (Attrition)", xlab = "Job Satisfaction", ylab = "Occurances") 
hist(CompNoAtt$JobSatisfaction, col = "green", breaks = 4,
     main = "Job Satisfaction (No Attrition)", xlab = "Job Satisfaction", ylab = "Occurances") 

hist(CompAtt$TotalWorkingYears, col = "red", breaks = 35,
     main = "Total Working Years (Attrition)", xlab = "Total Working Years", ylab = "Occurances") 
hist(CompNoAtt$TotalWorkingYears, col = "green", breaks = 35,
     main = "Total Working Years (No Attrition)", xlab = "Total Working Years", ylab = "Occurances") 

hist(CompAtt$TurnoverRatio, col = "red", breaks = 35,
     main = "Turnover Ratio (Attrition)", xlab = "Turnover Ratio", ylab = "Occurances") 
hist(CompNoAtt$TurnoverRatio, col = "green", breaks = 35,
     main = "Turnover Ratio (No Attrition)", xlab = "Turnover Ratio", ylab = "Occurances") 























# Compute new columns of data

## Turnover Ratio is based on the number of years in the work force divided by the number of companies worked.
## The higher the ratio the longer they stay with a company  
turnover = data.frame(TurnoverRatio = 1:cols)
for (i in 1:cols) {
  if (Comp[i,]$NumCompaniesWorked == 0) {
    turnover[i,] = Comp[i,]$TotalWorkingYears / (Comp[i,]$NumCompaniesWorked + 1)
  }
  else {
    turnover[i,] = Comp[i,]$TotalWorkingYears / Comp[i,]$NumCompaniesWorked
  }
}
Comp$TurnoverRatio = turnover$TurnoverRatio

# Split the data into a train and test set based on a defined percentage
set.seed(14)
splitPerc = 0.75
trainIndices = sample(1:dim(Comp)[1],round(splitPerc * dim(Comp)[1]))
train = Comp[trainIndices,]
test = Comp[-trainIndices,]

############################

stay <- Comp %>% filter(Attrition == "No")
go <- Comp %>% filter(Attrition == "Yes")

smallstay <- stay[-c(3,4,6,9,13,17,19,23,24)]
meanstay <- colMeans(smallstay)

smallstay <- rbind(smallstay, meanstay)

smallgo <- go[-c(3,4,6,9,13,17,19,23,24)]
meango <- colMeans(smallgo)

smallgo <- rbind(smallgo, meango)


allmeans <- data.frame(matrix(NA, nrow = 1, ncol = 28))
for (i in 1:28) {
  allmeans[,i] <- (smallstay[731,i] - smallgo[141,i]) / (smallstay[731,i] + smallgo[141,i])
}
colnames(allmeans) <- colnames(smallgo)

amr <- data.frame(r1=names(allmeans),t(allmeans))
colnames(amr) <- c("ID","value")

x <- amr[order(amr$value),]
x$value <- x$value * 100

x$line <- ifelse(x$value < 0, "below", "above")

ggplot(x, aes(x=reorder(ID, value), y=value)) + 
  geom_bar(stat='identity', aes(fill=line), width=.5)  +
  scale_fill_manual(name="Percentage Difference", 
                    labels = c("Above Average", "Below Average"), 
                    values = c("above"="#00ba38", "below"="#f8766d")) + 
  labs(x="Employee Data", subtitle="Normalized Percentage Difference between Attrition and Retention", 
       title= "Employee Stats - Diverging Bars") + 
  coord_flip()

# Data Prep

percentages <- data.frame(perc = 1:37)
percentages$perc = 0

# Plot charts for each contributing factor
Comp %>% select(Attrition, StockOptionLevel) %>% ggpairs(aes(color=Attrition))
Comp %>% select(Attrition, YearsInCurrentRole) %>% ggpairs(aes(color=Attrition))
Comp %>% select(Attrition, TurnoverRatio) %>% ggpairs(aes(color=Attrition))

Comp %>% select(Attrition, StockOptionLevel, YearsInCurrentRole, TurnoverRatio) %>% ggpairs(aes(color=Attrition))

###############################
# Knn
## First find the best k-factor
accs = data.frame(accuracy = numeric(30), k = numeric(30))

for(i in 1:30)
{
  classifications = knn(train[,c(2,33)],test[,c(2,33)],train$Attrition, prob = TRUE, k = i)
  table(test$Attrition,classifications)
  CM = confusionMatrix(table(test$Attrition,classifications))
  accs$accuracy[i] = CM$overall[1]
  accs$k[i] = i
}

plot(accs$k,accs$accuracy, type = "l", xlab = "k", ylab = "Accuracy", main = "K-factor vs Accuracy") 

# plot knn
test %>% ggplot(aes(x = Age, TurnoverRatio,color = Attrition)) + geom_point() + ggtitle("Age vs Gender") + theme(plot.title = element_text(hjust = 0.5))
train %>% ggplot(aes(x = Age, DistanceFromHome,color = Attrition)) + geom_point() + ggtitle("Age vs Gender") + theme(plot.title = element_text(hjust = 0.5))

# knn
classifications = knn(train[,c(2,33)],test[,c(2,33)],train$Attrition, prob = TRUE, k = 10)
table(test$Attrition,classifications)
CM = confusionMatrix(table(test$Attrition,classifications))
CM

# NB Model and Confusion Matrix
model = naiveBayes(train[,c(2,29,33,37)],factor(train$Attrition, labels = c("No", "Yes")))
table(factor(test$Attrition, labels = c("No", "Yes")),predict(model,test[,c(2,29,33,37)]))
CM = confusionMatrix(table(factor(test$Attrition, labels = c("No", "Yes")),predict(model,test[,c(2,29,33,37)])))
CM

#################################







```
